import IdentityMark from "../components/IdentityMark";
import { useSupabaseQuery } from "../lib/db";
import { Link } from "react-router-dom";
import Loader from "../components/Loader";
import { getYouTubeThumb } from "../lib/youtube";

export default function Home() {
  const { data: poems = [], loading: loadingPoems } = useSupabaseQuery('poems');
  const { data: videos = [], loading: loadingVideos } = useSupabaseQuery('videos');
  const { data: liveSettings = [], loading: loadingLive } = useSupabaseQuery('live_settings');

  const featuredPoem = (poems && poems[0]) || null;
  const featuredVideo = (videos && videos[0]) || null;
  const liveActive = (liveSettings && liveSettings[0] && liveSettings[0].enabled) || false;

  const isLoading = loadingPoems || loadingVideos || loadingLive;

  return (
    <div className="page">
      <section className="intro">
        <IdentityMark />
        
        <p>A mobile-first poetry & media space â€” public art, private control.</p>
      </section>

      {/* Show Live first if active */}
      {liveActive && (
        <section className="featured-card" style={{ borderColor: 'var(--accent)', borderWidth: 2 }}>
          <h4 style={{ margin: 0, color: 'var(--accent)', fontWeight: 700 }}>ðŸ”´ Live Now</h4>
          <div style={{ marginTop: 8 }}>
            <Link to="/live" className="btn-primary">Watch Live</Link>
          </div>
        </section>
      )}

      {/* Featured content */}
      <section className="featured-card">
        <h4 style={{ margin: 0, color: 'var(--muted)', fontWeight: 700 }}>Featured</h4>
        {isLoading ? (
          <Loader size="small" message="Loading featured content..." />
        ) : !featuredPoem && !featuredVideo ? (
          <div style={{ paddingTop: 8, color: 'var(--muted)' }}>No featured items yet. Add content in the dashboard.</div>
        ) : (
          <div style={{ display: 'grid', gap: 20, marginTop: 8 }}>
            {/* Featured Poem */}
            {featuredPoem && (
              <div>
                <h5 style={{ margin: '0 0 8px 0', fontSize: '14px', color: 'var(--muted)' }}>Poem</h5>
                <h3 style={{ margin: '6px 0 4px' }}>{featuredPoem.title}</h3>
                <p style={{ color: 'var(--muted)', marginBottom: 12 }}>{featuredPoem.body.split('\n').slice(0, 2).join(' ')}</p>
                <Link to={`/poems/${featuredPoem.id}`} className="btn-primary">Read</Link>
              </div>
            )}

            {/* Featured Video */}
            {featuredVideo && (
              <div>
                <h5 style={{ margin: '0 0 8px 0', fontSize: '14px', color: 'var(--muted)' }}>Video</h5>
                <div style={{ borderRadius: 8, overflow: 'hidden', marginBottom: 12 }}>
                  <img
                    src={getYouTubeThumb(featuredVideo.youtubeId || featuredVideo.youtube_url || "") || "/FLP.jpeg"}
                    alt={featuredVideo.title}
                    style={{ width: '100%', height: 'auto' }}
                  />
                </div>
                <h3 style={{ margin: '6px 0 4px' }}>{featuredVideo.title}</h3>
                <Link to="/videos" className="btn-primary">Watch</Link>
              </div>
            )}
          </div>
        )}
      </section>
    </div>
  );
}
